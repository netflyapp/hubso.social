// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Core Models ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  passwordHash String
  avatarUrl String?
  bio       String?
  role      Role     @default(MEMBER)
  status    UserStatus @default(ACTIVE)
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  communityMembers CommunityMember[]
  ownedCommunities Community[]
  spaceMemberships SpaceMember[]
  posts    Post[]
  comments Comment[]
  reactions Reaction[]
  groupMemberships GroupMember[]
  conversations ConversationParticipant[]
  messages Message[]
  events   EventAttendee[]
  notifications Notification[]
  uploadedMedia MediaFile[]
  auditLogs AuditLog[]
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

model Community {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?
  description String?
  settings  Json     @default("{}")
  plan      CommunityPlan @default(STARTER)
  customDomain String?
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   CommunityMember[]
  spaceGroups SpaceGroup[]
  spaces    Space[]
  groups    Group[]
  events    Event[]
  plugins   Plugin[]
  webhooks  Webhook[]
  auditLogs AuditLog[]
  mediaFiles MediaFile[]
  notifications Notification[]
}

enum CommunityPlan {
  STARTER
  GROWTH
  SCALE
  ENTERPRISE
}

model CommunityMember {
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        MemberRole @default(MEMBER)
  points      Int      @default(0)
  level       Int      @default(1)
  joinedAt    DateTime @default(now())

  @@id([communityId, userId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

// ==================== Spaces & Content ====================

model SpaceGroup {
  id          String   @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  name        String
  position    Int      @default(0)
  collapsedDefault Boolean @default(false)
  createdAt   DateTime @default(now())

  spaces Space[]

  @@index([communityId])
}

model Space {
  id            String   @id @default(cuid())
  communityId   String
  community     Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  spaceGroupId  String?
  spaceGroup    SpaceGroup? @relation(fields: [spaceGroupId], references: [id], onDelete: SetNull)
  name          String
  description   String?
  type          SpaceType
  visibility    SpaceVisibility @default(PUBLIC)
  paywallEnabled Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  members SpaceMember[]
  posts   Post[]
  events  Event[]

  @@index([communityId])
  @@index([spaceGroupId])
}

enum SpaceType {
  POSTS
  CHAT
  EVENTS
  LINKS
  FILES
}

enum SpaceVisibility {
  PUBLIC
  PRIVATE
  SECRET
}

model SpaceMember {
  spaceId String
  space   Space  @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    SpaceMemberRole @default(MEMBER)
  addedAt DateTime @default(now())

  @@id([spaceId, userId])
  @@index([userId])
}

enum SpaceMemberRole {
  OWNER
  MODERATOR
  MEMBER
}

model Post {
  id          String   @id @default(cuid())
  spaceId     String
  space       Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content     Json     // Tiptap JSON
  type        PostType @default(TEXT)
  status      PostStatus @default(PUBLISHED)
  pinned      Boolean  @default(false)
  featured    Boolean  @default(false)
  reactionsCount Json @default("{}")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  comments Comment[]
  reactions Reaction[]

  @@index([spaceId])
  @@index([authorId])
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  POLL
  LINK
  EMBED
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentId  String?  // For threading
  parent    Comment? @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  content   Json     // Tiptap JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  replies Comment[] @relation("CommentThread")
  reactions Reaction[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Reaction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetType String  // "Post" | "Comment" | "Message"
  targetId  String
  type      ReactionType
  createdAt DateTime @default(now())

  post    Post? @relation(fields: [targetId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([userId])
  @@index([targetId])
}

enum ReactionType {
  LIKE
  LOVE
  WOW
  FIRE
  SAD
  ANGRY
}

// ==================== Groups ====================

model Group {
  id          String   @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  name        String
  description String?
  visibility  GroupVisibility @default(PUBLIC)
  memberCount Int      @default(0)
  rules       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members GroupMember[]

  @@index([communityId])
}

enum GroupVisibility {
  PUBLIC
  PRIVATE
  HIDDEN
}

model GroupMember {
  groupId String
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId  String
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    GroupMemberRole @default(MEMBER)
  joinedAt DateTime @default(now())

  @@id([groupId, userId])
  @@index([userId])
}

enum GroupMemberRole {
  OWNER
  MODERATOR
  MEMBER
}

// ==================== Messaging ====================

model Conversation {
  id        String   @id @default(cuid())
  type      ConversationType
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
}

enum ConversationType {
  DIRECT
  GROUP
}

model ConversationParticipant {
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())

  @@id([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  type           MessageType @default(TEXT)
  parentId       String?  // For message threading/replies
  readAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@index([parentId])
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  VOICE
  VIDEO
}

// ==================== Events ====================

model Event {
  id          String   @id @default(cuid())
  spaceId     String
  space       Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime
  locationType EventLocationType @default(VIRTUAL)
  location    String?
  recurringRule String? // RRULE format
  maxAttendees Int?
  ticketPrice Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attendees EventAttendee[]

  @@index([spaceId])
  @@index([creatorId])
}

enum EventLocationType {
  VIRTUAL
  IN_PERSON
  HYBRID
}

model EventAttendee {
  eventId  String
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  status   AttendeeStatus @default(MAYBE)
  joinedAt DateTime @default(now())

  @@id([eventId, userId])
  @@index([userId])
}

enum AttendeeStatus {
  GOING
  MAYBE
  NOT_GOING
}

// ==================== Notifications ====================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  communityId String?
  community Community? @relation(fields: [communityId], references: [id], onDelete: Cascade)
  type      NotificationType
  data      Json     @default("{}")
  readAt    DateTime?
  channel   NotificationChannel @default(IN_APP)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([communityId])
}

enum NotificationType {
  POST_LIKE
  POST_COMMENT
  MENTION
  MESSAGE
  EVENT_INVITE
  MEMBER_JOIN
  SPACE_UPDATE
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

// ==================== Media ====================

model MediaFile {
  id        String   @id @default(cuid())
  uploadedById String
  uploadedBy  User   @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  communityId String?
  community   Community? @relation(fields: [communityId], references: [id], onDelete: SetNull)
  storageKey String   @unique
  cdnUrl    String
  status    MediaStatus @default(PROCESSING)
  type      MediaType
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([uploadedById])
  @@index([communityId])
}

enum MediaStatus {
  PROCESSING
  READY
  FAILED
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  FILE
}

// ==================== Plugins ====================

model Plugin {
  id        String   @id @default(cuid())
  communityId String?
  community Community? @relation(fields: [communityId], references: [id], onDelete: Cascade)
  name      String
  slug      String   @unique
  version   String
  status    PluginStatus @default(ACTIVE)
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([slug])
}

enum PluginStatus {
  ACTIVE
  DISABLED
  ERROR
}

// ==================== Webhooks ====================

model Webhook {
  id        String   @id @default(cuid())
  communityId String
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  url       String
  secret    String   @default(cuid())
  events    Json     @default("[]")
  active    Boolean  @default(true)
  failureCount Int   @default(0)
  lastFailedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
}

// ==================== Audit Log ====================

model AuditLog {
  id        String   @id @default(cuid())
  communityId String
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  action    String
  targetType String
  targetId  String?
  metadata  Json     @default("{}")
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([communityId])
  @@index([actorId])
  @@index([createdAt])
}
